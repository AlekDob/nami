---
type: diary
project: namios
date: 2026-02-18
---

- [PM] (Alek) fix: macOS freeze on chat messages — 7 root causes found + 1 architectural fix across 5 rounds of debugging. Causes: (1) AutoSizingTextView layout→invalidate loop, (2) uncached nsAttributedString, (3) URL regex on every "h", (4) updateNSView bypassing layout guard, (5) spring animation forcing per-frame ensureLayout, (6) ContentView @Observable cascade, (7) isAutomaticLinkDetectionEnabled modifies textStorage → resets guard → loop. All 7 patches applied but still froze on 1211-char message (killed by macOS watchdog). **Definitive fix**: dropped NSTextView entirely on macOS, replaced with `Text(AttributedString)` + `.textSelection(.enabled)`. Manual NSAttributedString→AttributedString conversion. Trade-off: macOS loses word-level selection. NSTextView's `ensureLayout()` is fundamentally incompatible with SwiftUI's reactive rendering.
- [PM] (Alek) fix: X/Twitter tools broken on headless server — root cause: `ensureLoggedIn()` tried username/password login via Playwright but X blocks with CAPTCHA/2FA on headless Hetzner. Solution: switched to `storageState` pattern (same as AWS Cognito) — login manually once on Mac via `x-login.ts` script, export cookies as JSON, reuse on server. Deleted `x-api.ts` (Twitter API v2 requires paid bearer token). Reddit-like anonymous scraping not possible for X (no public .json endpoints).
- [PM] (Alek) fix: X cookies had garbage bytes — AES-CBC first block (16 bytes) decrypts to garbage because Chromium's actual IV differs from the documented static IV (16 spaces). Cookie values are always printable ASCII, so fix strips leading non-printable chars. Also: `expires: -1` caused Playwright `Invalid cookie fields` error. Cleaned 20 cookies, deployed, X tools now working (5 tweets returned on test search).
- [PM] (Alek) feat: macOS Services integration for AI Commands — added `NSServices` to Info.plist (7 services: 6 presets + "Process with Nami..." generic picker). Created `NamiServicesProvider.swift` as `@objc` handler registered via `NSApp.servicesProvider`. Services appear in right-click → Services → Nami/ submenu in ALL apps. Text is passed directly by macOS (no AXUIElement/⌘C hack needed). Also created `ServicePickerPanel.swift` with floating HUD for the generic command picker. Solves two problems: shortcut conflicts with other apps AND AI Commands not working in some apps (Electron, sandboxed).
- [PM] (Alek) fix: macOS Services not appearing — 3 gotchas discovered: (1) `NSPortName` was "Nami" but `CFBundleName` is "NamiOS" — silent routing failure; (2) PBS only discovers Services from apps in `/Applications`, not Xcode DerivedData; (3) Services require manual user enablement via System Settings → Keyboard → Shortcuts → Services (macOS security restriction, can't be bypassed). All three documented as gotchas.
- [PM] (Alek) fix: ServicePickerPanel position — changed from `showCentered()` (center of screen) to `showNearMouse()` using `NSEvent.mouseLocation` with screen bounds clamping. Picker now opens contextually near the right-click location.
- [PM] (Alek) feat: local (non-AI) commands for NamiOS — extended `AICommand` SwiftData model with `commandTypeRaw` (ai/local) and `script` fields. Added `executeLocalScript()` in `AICommandExecutor` using `Process` + `/bin/bash` with `$NAMI_INPUT` env var and 10s timeout. Updated edit view with type picker (AI/Local) and conditional prompt/script fields. Server: created `createLocalCommand` + `createAICommand` tools in `src/tools/local-command.ts` so Nami can self-create commands via chat. Added REST endpoints `GET/POST/DELETE /api/commands` for client sync. Client `syncFromServer()` in ViewModel downloads server-created commands and inserts missing ones into SwiftData.
- [18:30] (Alek) feat: notch quick commands now execute AI Commands via AICommandExecutor instead of sending chat messages. Wired onExecuteCommand callback through NotchPanelManager → MeowApp → AICommandExecutor. Commands capture selected text, process via API, show ResultPanel with Copy/Replace.
