---
type: diary
project: namios
date: 2026-02-16
---

# 2026-02-16

## Text Selection (iOS + macOS) — Partial Word Selection
- **Problem**: Long-press on message text showed "Copy | Share" (select-all) but couldn't select a single word or range
- **Root cause**: SwiftUI `.textSelection(.enabled)` on `Text(AttributedString)` only supports select-all on iOS — no word-level drag handles
- **Fix**: Created `SelectableText` (`UIViewRepresentable` / `NSViewRepresentable`) wrapping `UITextView` (iOS) / `NSTextView` (macOS) with `isEditable = false, isSelectable = true`
- Replaced all `Text(styledAttributedString(...))` in `MarkdownText.swift` with `SelectableText(attributedString:)` using `NSAttributedString`
- Removed `.textSelection(.enabled)` from `ChatBubble.swift` — no longer needed
- Removed `.onTapGesture` from `ChatView` root ZStack (was blocking gestures) — replaced with `.scrollDismissesKeyboard(.interactively)`
- Created gotcha: `gotcha-ontapgesture-blocks-textselection.md`

## Cron Push Notifications — Double Push + No Deep Link
- **Problem**: Each cron job sent 2 push notifications ("Task firing" + "Task: result"), and tapping either opened nothing
- **Root cause 1**: `onNotify` and `onTrigger` both called `sendPushNotification` — neither passed `sessionId`
- **Root cause 2**: Cron jobs ran `agent.run()` directly (not via WebSocket), so no session was ever created
- **Root cause 3**: Both `meow.service` and `nami.service` were active — same code, same jobs.json — doubling all cron executions
- **Fix**: Removed push from `onNotify` (keep Discord only). In `onTrigger`, create a session via SessionStore with source `'job'`, persist user+assistant messages, pass `sessionId` to push. Disabled `meow.service`.
- Key insight: any server-side execution that needs mobile deep-linking must create its own session
- Created bug doc: `bugs/fix-cron-double-push-missing-sessionid.md`
- Created gotcha: `gotchas/gotcha-duplicate-systemd-services.md`

## AI Commands — Raycast-style Text Processing (Full Feature)
- (Agent Swift) Implemented complete AI Commands system as Raycast Pro replacement
- **Data Model**: `AICommand` SwiftData model with name, prompt template (`{input}` placeholder), hotkey, output mode (clipboard/panel/chat), enabled toggle, sort order
- **Presets**: 6 built-in commands (Translate EN/FR/IT, Summarize, Rewrite Formal, Fix Grammar) seeded on first launch
- **macOS Hotkey System**: Extended `GlobalHotkeyManager` to support N hotkeys (Quick Input + AI Commands). `AICommandExecutor` handles full flow: NSEvent → simulates ⌘C → reads pasteboard → compiles prompt → POST /api/command → routes output (clipboard/panel/chat)
- **ResultPanel**: New floating NSPanel (blur, glassmorphism) for displaying AI command results with copy action
- **Conflict Detection**: `hasConflict()` prevents duplicate shortcuts across Quick Input and all AI Commands
- **Settings UI**: `AICommandsListView` (CRUD list with toggle/reorder/delete), `AICommandEditView` (name, prompt, output mode, hotkey recorder), integrated into SettingsView
- **Backend**: New `POST /api/command` endpoint — lightweight LLM call (no tools, no memory, no session tracking) for fast prompt→response
- **iOS Share Extension**: Updated to show AI Command picker as horizontal chips. Commands synced to App Group via `SharedAICommand` JSON in UserDefaults. Runs `/api/command` directly from extension, auto-copies to clipboard
- **Key insight**: Share Extension can't access SwiftData — solved with lightweight JSON sync to shared UserDefaults on every save

## AI Commands — Iterative UX Polish + Sidebar Promotion
- (Agent Swift) Multiple rounds of UX refinement based on real-world testing:
- **Text Capture**: CGEvent ⌘C simulation unreliable — switched to 3-tier strategy: AXUIElement (Accessibility API) primary → simulated ⌘C fallback → error
- **Fast Model**: GPT-4o Mini was too chatty for command output. Created `pickFastDirectModel()` in `src/config/models.ts` — prefers Kimi K2/MiniMax/GLM Flash direct, avoids OpenRouter overhead
- **Immediate Feedback**: Added shimmer skeleton loader (3 bars) shown instantly while AI processes
- **Replace Button**: Stores `sourceApp` at trigger time, pastes result via simulated ⌘V back into original app
- **ResultPanel Dark Mode**: Forced `.preferredColorScheme(.dark)` — light mode colors were unreadable
- **No Auto-Dismiss**: User must close panel manually (X or Esc). No resignKey dismiss either
- **Separated "Copied" Badge**: `autoCopied` bool shows green badge in header instead of polluting AI result text
- **Modifier Flags Gotcha**: `⌘⇧` = `0x120000`, `⌘⇧⌥` = `0x1A0000`. Initial values were wrong (0x180100) — required one-time migration
- **NSUserNotification deprecated**: macOS 11+ doesn't show NSUserNotification — must use floating panel or UNUserNotification
- **Promoted to Sidebar**: AI Commands moved from Settings subsection to top-level `AppTab.aiCommands` with its own sidebar entry (icon: `bolt.horizontal`)
- Created comprehensive pattern doc: `documentation/patterns/pattern-ai-commands-raycast-style.md`

## AI Commands — UI Polish (List + Edit Views)
- (Agent Swift) Improved spacing, padding, and visual hierarchy in both views
- **AICommandsListView**: custom `listRowInsets`, icon in 28x28 rounded square, 14pt spacing, prompt preview with newline cleanup, `scaleEffect(0.85)` on toggle, removed section header
- **AICommandEditView**: `.formStyle(.grouped)`, section headers with SF Symbols (`sectionHeader("Name", icon: "textformat")`), `scrollContentBackground(.hidden)` on TextEditor, footer with `info.circle` Label, Delete as `role: .destructive` with trash icon, Save tinted green

## Sessions Tab — Move Sessions from Sidebar to Dedicated Tab
- (Agent Swift) Moved session list from sidebar drawer (iOS) and split view (macOS) to a dedicated "Chat" tab
- **Before**: Sessions occupied top half of sidebar, pushing feature tabs down. Sidebar felt cluttered, especially on iPhone.
- **After**: Sidebar shows only feature tabs (Chat, Nami, OS, Memory, Jobs, etc.). Tab "Chat" opens full-screen `SessionListView` with header (hamburger + "Sessions" + New Chat). Selecting a session navigates to `ChatView` with back chevron to return.
- **Files changed**: `ContentView.swift` (removed SessionListView from both `sidebarDrawer` and `splitViewLayout`, added `showSessionList` state, updated `tabContent` routing), `ChatView.swift` (replaced hamburger with back chevron, added `onBackToSessions` callback, removed `onMenuTap`), `SessionListView.swift` (added full-screen header with hamburger/title/new-chat, added `onMenuTap` callback, added theme colors)
- **Key insight**: sidebar should only contain navigation tabs, not content lists. Session list is content and belongs in the main panel.

## macOS Chat Rendering — Invisible AI Responses (SelectableText height=0)
- **Problem**: AI responses rendered on macOS with copy/TTS icons visible but text completely invisible (white on white appearance). iPhone worked fine.
- **Root cause**: `SelectableText` macOS impl used `NSTextView.scrollableTextView()` which wraps in `NSScrollView`. The `NSScrollView` doesn't communicate `intrinsicContentSize` to SwiftUI — so SwiftUI gave it height 0. Manual `scrollView.frame.size.height` assignment in `updateNSView` is ignored by SwiftUI's layout engine.
- **Fix**: Replaced `NSScrollView` wrapper with standalone `AutoSizingTextView` (NSTextView subclass) that overrides `intrinsicContentSize` to return the actual text layout height. SwiftUI reads this correctly.
- **Key insight**: Never use `NSTextView.scrollableTextView()` in `NSViewRepresentable` — SwiftUI ignores direct frame modifications. Use a standalone NSTextView with `intrinsicContentSize` override instead.
